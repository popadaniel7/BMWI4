#include "CenLoc.h"
#include "stdio.h"
#include "string.h"
#include "stdlib.h"
#include "ExtLights.h"
#include "IntLights.h"
#include "SecAlm.h"
#include "tim.h"
#include "usart.h"
#include "gpio.h"

uint8_t CurrentState_Door;
uint8_t CurrentState_CenLoc;
uint8_t BTCenLoc;
uint8_t BTCenLoc_IrqFlag;
uint8_t PrevState;

void CenLoc_MainFunction()
{
	uint16_t TimeStamp = 0;


	if(PrevState != BTCenLoc)
	{
		AlarmCount1 = 0;
	}

	PrevState = BTCenLoc;

	if(BTCenLoc == STD_HIGH)
	{
		TimeStamp = __HAL_TIM_GET_COUNTER(&htim11);
		CurrentState_CenLoc = STD_HIGH;

		CenLoc_Toggle_Door_LED(CurrentState_CenLoc);
		SecAlm_ToggleAlarmLed(!CurrentState_CenLoc);

		if(__HAL_TIM_GET_COUNTER(&htim11) - TimeStamp < 5000)
		{
			SecAlm_ToggleAlarmBuzzer(STD_HIGH);
		}
		else if((5000 < (__HAL_TIM_GET_COUNTER(&htim11) - TimeStamp)) && ((__HAL_TIM_GET_COUNTER(&htim11) - TimeStamp) < 10000))
		{
			SecAlm_ToggleAlarmBuzzer(STD_LOW);
		}
		else if((10000 < (__HAL_TIM_GET_COUNTER(&htim11) - TimeStamp)) && ((__HAL_TIM_GET_COUNTER(&htim11) - TimeStamp) < 15000))
		{
			SecAlm_ToggleAlarmBuzzer(STD_HIGH);
		}
		else if((15000 < (__HAL_TIM_GET_COUNTER(&htim11) - TimeStamp)) && ((__HAL_TIM_GET_COUNTER(&htim11) - TimeStamp) < 20000))
		{
			SecAlm_ToggleAlarmBuzzer(STD_LOW);
		}
		else if((__HAL_TIM_GET_COUNTER(&htim11) - TimeStamp) < 20000)
		{
			SecAlm_ToggleAlarmBuzzer(STD_LOW);
		}
		else
		{
			/* do nothing */
		}



	}
}

uint8_t CenLoc_Init()
{
	CurrentState_Door = STD_LOW;
	CurrentState_CenLoc = STD_LOW;
	BTCenLoc = STD_LOW;

	return E_OK;
}

void CenLoc_Toggle_Door_LED(uint8_t PinState)
{
	HAL_GPIO_WritePin(GPIOB, GPIO_PIN_6, PinState);
}

