#include "CenLoc.h"
#include "stdio.h"
#include "string.h"
#include "stdlib.h"
#include "ExtLights.h"
#include "IntLights.h"
#include "SecAlm.h"
#include "tim.h"
#include "usart.h"
#include "gpio.h"

uint8 CurrentState_Door;
uint8 CurrentState_CenLoc;
uint8 BTCenLoc;
uint8 BTCenLoc_IrqFlag;
uint8 CenLoc_PrevState;
uint32 TimeStampAlarm;
uint32 TimeStampExtLights;
uint32 TimeStampAlarmLed;
uint32 SecondTimeStampAlarm;
uint32 SecondTimeStampExtLights;
uint32 SecondTimeStampAlarmLed;
uint8 ExtLights_UnlockedState;
uint8 ExtLights_LockedState;

void CenLoc_MainFunction()
{
	if(CenLoc_PrevState != CurrentState_CenLoc)
	{
		ExtLights_LockedState = CenLoc_PrevState;
		ExtLights_UnlockedState = CurrentState_CenLoc;
		CenLoc_PrevState = CurrentState_CenLoc;
		BTCenLoc_IrqFlag = !CurrentState_CenLoc;
		AlarmCount1 = STD_LOW;
		AlarmCount2 = STD_LOW;

		HAL_TIM_Base_Init(&htim2);
		HAL_TIM_Base_Init(&htim3);
		HAL_TIM_Base_Init(&htim5);
	}
	else
	{
		/* do nothing */
	}

	if(CurrentState_CenLoc == STD_HIGH)
	{

		BTCenLoc = STD_HIGH;

		IntLights_Toggle_IntLights(CurrentState_CenLoc);
		CenLoc_Toggle_Door_LED(CurrentState_CenLoc);
		SecAlm_ToggleAlarmLed(!CurrentState_CenLoc);

		if(ExtLights_UnlockedState == 1 && ExtLights_LockedState == 0)
		{
			HAL_TIM_Base_Start(&htim5);
			if(__HAL_TIM_GET_COUNTER(&htim5) < 100000)
			{
				ExtLights_FogLightFront(CurrentState_CenLoc);
				ExtLights_LowBeam(CurrentState_CenLoc);
				ExtLights_PositionLightRear(CurrentState_CenLoc);
			}
			else
			{
				ExtLights_FogLightFront(!CurrentState_CenLoc);
				ExtLights_LowBeam(!CurrentState_CenLoc);
				ExtLights_PositionLightRear(!CurrentState_CenLoc);

				ExtLights_UnlockedState = 0;
				ExtLights_LockedState = 1;

				HAL_TIM_Base_Stop(&htim5);
			}
		}
		else
		{
			/* do nothing */
		}



		if(AlarmCount1 < 4)
		{
			HAL_TIM_Base_Start(&htim2);
			HAL_TIM_PWM_Start_IT(&htim9, TIM_CHANNEL_1);

			if(__HAL_TIM_GET_COUNTER(&htim2) < 2500)
			{
				ExtLights_TurnSignalLeft(CurrentState_CenLoc);
				ExtLights_TurnSignalRight(CurrentState_CenLoc);
			}
			else if(2500 < __HAL_TIM_GET_COUNTER(&htim2) && __HAL_TIM_GET_COUNTER(&htim2) < 5000)
			{
				ExtLights_TurnSignalLeft(!CurrentState_CenLoc);
				ExtLights_TurnSignalRight(!CurrentState_CenLoc);
			}
			else if(5000 < __HAL_TIM_GET_COUNTER(&htim2) && __HAL_TIM_GET_COUNTER(&htim2) < 7500)
			{
				ExtLights_TurnSignalLeft(CurrentState_CenLoc);
				ExtLights_TurnSignalRight(CurrentState_CenLoc);
			}
			else if(7500 < __HAL_TIM_GET_COUNTER(&htim2) && __HAL_TIM_GET_COUNTER(&htim2) < 10000)
			{
				ExtLights_TurnSignalLeft(!CurrentState_CenLoc);
				ExtLights_TurnSignalRight(!CurrentState_CenLoc);

				AlarmCount1++;
			}
			else
			{
				/* do nothing */
			}
		}
		else if(AlarmCount1 >= 4 && HAL_TIM_Base_Start(&htim2) != 0)
		{
			HAL_TIM_Base_Stop(&htim2);
		}
		else
		{
			/* do nothing */
		}
	}
	else if(CurrentState_CenLoc == STD_LOW)
	{
		BTCenLoc = STD_LOW;
		HAL_TIM_Base_Stop(&htim2);
		IntLights_Toggle_IntLights(CurrentState_CenLoc);
		CenLoc_Toggle_Door_LED(CurrentState_CenLoc);

		HAL_TIM_Base_Start(&htim3);

		if(ExtLights_UnlockedState == 0 && ExtLights_LockedState == 1)
		{
			HAL_TIM_Base_Start(&htim5);
			if(__HAL_TIM_GET_COUNTER(&htim5) < 100000)
			{
				ExtLights_FogLightFront(!CurrentState_CenLoc);
				ExtLights_LowBeam(!CurrentState_CenLoc);
				ExtLights_PositionLightRear(!CurrentState_CenLoc);
			}
			else if(__HAL_TIM_GET_COUNTER(&htim5) > 100000)
			{
				ExtLights_FogLightFront(CurrentState_CenLoc);
				ExtLights_LowBeam(CurrentState_CenLoc);
				ExtLights_PositionLightRear(CurrentState_CenLoc);

				ExtLights_UnlockedState = 1;
				ExtLights_LockedState = 0;

				HAL_TIM_Base_Stop(&htim5);
			}
		}
		else
		{
			/* do nothing */
		}

		if(__HAL_TIM_GET_COUNTER(&htim3) < 1250)
		{
			SecAlm_ToggleAlarmLed(!CurrentState_CenLoc);
		}
		else if(1250 < __HAL_TIM_GET_COUNTER(&htim3) && __HAL_TIM_GET_COUNTER(&htim3) < 2500)
		{
			SecAlm_ToggleAlarmLed(CurrentState_CenLoc);
		}
		else if(2500 < __HAL_TIM_GET_COUNTER(&htim3) && __HAL_TIM_GET_COUNTER(&htim3) < 3750)
		{
			SecAlm_ToggleAlarmLed(!CurrentState_CenLoc);
		}
		else if(3750 < __HAL_TIM_GET_COUNTER(&htim3) && __HAL_TIM_GET_COUNTER(&htim3) < 5000)
		{
			SecAlm_ToggleAlarmLed(CurrentState_CenLoc);
		}
		else
		{
			/* do nothing */
		}

		if(AlarmCount2 < 2 && BTCenLoc_IrqFlag == STD_HIGH)
		{
			HAL_TIM_Base_Start(&htim2);

			if(__HAL_TIM_GET_COUNTER(&htim2) < 2500)
			{
				ExtLights_TurnSignalLeft(!CurrentState_CenLoc);
				ExtLights_TurnSignalRight(!CurrentState_CenLoc);
			}
			else if(2500 < __HAL_TIM_GET_COUNTER(&htim2) && __HAL_TIM_GET_COUNTER(&htim2) < 5000)
			{
				ExtLights_TurnSignalLeft(CurrentState_CenLoc);
				ExtLights_TurnSignalRight(CurrentState_CenLoc);

				AlarmCount2++;
			}
			else
			{
				/* do nothing */
			}
		}
		else if(AlarmCount1 >= 2)
		{
			HAL_TIM_Base_Stop(&htim2);
		}
		else
		{
			/* do nothing */
		}
	}
}

StdReturnType CenLoc_Init()
{
	CurrentState_Door = STD_LOW;
	CurrentState_CenLoc = STD_LOW;
	BTCenLoc = STD_LOW;
	TimeStampAlarm = STD_LOW;
	TimeStampExtLights = STD_LOW;
	TimeStampAlarmLed = STD_LOW;
	SecondTimeStampAlarm = STD_LOW;
	SecondTimeStampExtLights = STD_LOW;
	SecondTimeStampAlarmLed = STD_LOW;
	ExtLights_UnlockedState = STD_LOW;
	ExtLights_LockedState = STD_LOW;

	return E_OK;
}

void CenLoc_Toggle_Door_LED(uint8 PinState)
{
	HAL_GPIO_WritePin(DOOR_LED_PORT, DOOR_LED_PIN, PinState);
}

